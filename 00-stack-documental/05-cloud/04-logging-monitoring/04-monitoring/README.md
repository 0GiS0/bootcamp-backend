# 04 Monitoring

In this example we are going to monitoring Nodejs app with New Relic.

We will start from `03-deploy-heroku`.

# Steps to build it

`npm install` to install previous sample packages:

```bash
cd front
npm install

```

In a second terminal:

```bash
cd back
npm install

```

In this example, we will monitoring the Nodejs app using [New Relic](https://newrelic.com/), we could create new account in the official web:

Let's create new account:

![01-create-new-relic-account](./readme-resources/01-create-new-relic-account.png)

Click on `APM options` and select NodeJS:

![02-click-apm-options](./readme-resources/02-click-apm-options.png)

> Copy Account ID and License Key too.

Select `Package manager`:

![03-select-package-manager](./readme-resources/03-select-package-manager.png)


Select `Node standard installation`:

![04-select-node-standar-install](./readme-resources/04-select-node-standar-install.png)

Give app name:

![05-give-app-name](./readme-resources/05-give-app-name.png)

Install `new relic` in back app:

_back terminal_

```bash
npm install newrelic --save

```

Use it:

_./back/src/index.ts_

```diff
import { config } from 'dotenv';
config();

+ const { envConstants } = require('./core/constants');
+ if (envConstants.isProduction) {
+   require('newrelic');
+ }

require('./app');

```

Let's remove the `unexpected error`:

_./back/src/pods/book/book.rest-api.ts_

```diff
...

booksApi
  .get('/', authorizationMiddleware(), async (req, res, next) => {
    try {
-     const book = undefined;
-     book.name;
      const page = Number(req.query.page);
      const pageSize = Number(req.query.pageSize);
      const bookList = await bookRepository.getBookList(page, pageSize);
      res.send(mapBookListFromModelToApi(bookList));
    } catch (error) {
      next(error);
    }
  })
...
```

`Download your custom configuration file` provided by New Relic to see app token, but instead of added it to the project, we will [configure it using env variables](https://docs.newrelic.com/docs/agents/nodejs-agent/installation-configuration/nodejs-agent-configuration/#exports_config).

![06-download-custom-config-file](./readme-resources/06-download-custom-config-file.png)

We will create these env variables in Heroku:

![07-new-relic-env-variables](./readme-resources/07-new-relic-env-variables.png)

Deploy new version:

```bash
git add .
git commit -m "configure new relic"
git push

```

Check data in New Relic portal:

![08-check-data](./readme-resources/08-check-data.png)

If we play with the app, we could check all queries in `Distributed tracing` tab:

![09-distributed-tracing-tab](./readme-resources/09-distributed-tracing-tab.png)

If we check `Service map` and `Dependencies` tabs, we could see which external services we are using:

![10-service-map](./readme-resources/10-service-map.png)

![11-dependencies](./readme-resources/11-dependencies.png)

We could check which query consume more clock time in `Transactions` tab:

![12-transactions](./readme-resources/12-transactions.png)

And server statistics in `Node VMs` tab:

![13-node-vms](./readme-resources/13-node-vms.png)

Let's deploy a [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) as we did in `05-cloud > 02-deploy > 03-mongo-deploy` to see MongoDB statistics:

![14-start-free-cluster](./readme-resources/14-start-free-cluster.png)

We could select between three providers and different regions:

![15-select-provider-and-region](./readme-resources/15-select-provider-and-region.png)

Select the cluster tier, in this case `M0 Sandbox` which it's a free tier with No backup:

![16-select-cluster-tier](./readme-resources/16-select-cluster-tier.png)

Finally, give a name (if you want) and create the cluster:

![17-create-cluster](./readme-resources/17-create-cluster.png)

This is the main cluster page, where we will see:

- Configure Network Access.
- Configure Database Access.
- See mongo connection URI.
- See collections and documents.

![18-main-cluster-page](./readme-resources/18-main-cluster-page.png)

By default, MongoDB Atlas only allows access to configured IPs, let's add a new rule to allow all IPs:

![19-configure-network-access](./readme-resources/19-configure-network-access.png)

Let's configure database access, adding new user:

![20-configure-database-access](./readme-resources/20-configure-database-access.png)

> Let's copy the autogenerated password. We will use in the MongoDB Connection URI

Let's copy the `MongoDB Connection URI`:

![21-click-connect-button](./readme-resources/21-click-connect-button.png)

![22-copy-connection-uri](./readme-resources/22-copy-connection-uri.png)

Update env variable:

_./back/.env_

```diff
...
API_MOCK=true
- MONGODB_URI=mongodb://localhost:27017/book-store
+ MONGODB_URI=mongodb+srv://<user>:<password>@<cluster>.mongodb.net/book-store?retryWrites=true&w=majority
AUTH_SECRET=MY_AUTH_SECRET
...

```

> Replace <user>, <password> and <cluster> with MongoDB Atlas provided values.

And run backend `seed-data` runner:

```bash
npm run start:console-runners

> seed-data

```

Update env variables in Heroku:

![23-update-env-variables](./readme-resources/23-update-env-variables.png)

Now, if we play with the app, we could see MongoDB statistics:

![24-mongodb-summary](./readme-resources/24-mongodb-summary.png)

![25-mongodb-service-map](./readme-resources/25-mongodb-service-map.png)

![26-mongodb-databases](./readme-resources/26-mongodb-databases.png)

# ¿Con ganas de aprender Backend?

En Lemoncode impartimos un Bootcamp Backend Online, centrado en stack node y stack .net, en él encontrarás todos los recursos necesarios: clases de los mejores profesionales del sector, tutorías en cuanto las necesites y ejercicios para desarrollar lo aprendido en los distintos módulos. Si quieres saber más puedes pinchar [aquí para más información sobre este Bootcamp Backend](https://lemoncode.net/bootcamp-backend#bootcamp-backend/banner).
